<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyJL8IZONFaSpzh3DUo3nmPNGIwe5uTXP8t5f-lzLOEaS_D6wZaYfga46qaL9hz_Q31/exec"; 

    // (中略：render, updateClockなどはそのまま)

    // ストップ時の処理を強化
    async function stopTimer(isComplete) {
        if(!timerState) return;
        const task = tasks.find(x => x.id === timerState.taskId);
        
        // 実際の経過時間を計算
        const elapsed = timerState.baseElapsed + Math.floor((Date.now() - timerState.startTime) / 1000);
        task.elapsed = elapsed;

        if(isComplete) {
            task.done = true;
            // ログ送信（タスク名、目標時間、かかった秒数）
            await sendLogToGAS(task.name, task.time, elapsed);
        }
        
        timerState = null;
        localStorage.removeItem('tadaima_v44_timer_state');
        document.getElementById('timer-overlay').style.display = 'none';
        render();
    }

    async function sendLogToGAS(taskName, goalTime, elapsedTime) {
        if (!GAS_URL || GAS_URL.includes("ここに")) return;
        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ taskName, goalTime, elapsedTime })
            });
        } catch (e) { console.error("送信失敗", e); }
    }
</script>
