<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŸã ã„ã¾ã£ã´ãƒ¼ğŸŒ‡V2.1</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root { --p-blue: #4a90e2; --s-green: #4cd964; --w-red: #ff3b30; --bg: #f0f7ff; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .dashboard { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        .time-display { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .time-box h2 { font-size: 0.8rem; color: #888; margin: 0; }
        .time-box p { font-size: 1.5rem; font-weight: bold; margin: 5px 0; color: var(--p-blue); }
        .time-box p.bedtime { color: var(--w-red); }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #task-list { width: 100%; max-width: 500px; padding: 0; list-style: none; }
        .card { background: white; margin-bottom: 10px; padding: 15px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card.checked { opacity: 0.5; background: #eee; }
        .card.checked .name { text-decoration: line-through; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .check-btn { width: 30px; height: 30px; border: 2px solid #ddd; border-radius: 50%; margin-right: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .checked .check-btn { background: var(--s-green); border-color: var(--s-green); color: white; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--p-blue); color: white; }
        .btn-edit { background: #f1c40f; color: white; }
        
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ */
        .handle { display: none; margin-right: 10px; color: #ccc; cursor: grab; }
        .edit-tool { display: none; margin-left: auto; gap: 10px; }
        body.edit-mode .handle, body.edit-mode .edit-tool { display: flex; }
        body.edit-mode .check-btn { display: none; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
        .modal-content { background:white; padding:20px; border-radius:15px; width:80%; max-width:300px; }
        .modal-content input { width:100%; padding:10px; margin:10px 0; box-sizing:border-box; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="time-display">
            <div class="time-box"><h2>ç¾åœ¨</h2><p id="now-t">--:--</p></div>
            <div class="time-box"><h2>å¯ã‚‹äºˆå®š</h2><p id="bed-t" class="bedtime">--:--</p></div>
        </div>
        <div id="left-t" style="font-size: 0.9rem; color: #666;">ã®ã“ã‚Šåˆè¨ˆ: --åˆ†</div>
    </div>

    <div class="controls">
        <button class="btn btn-add" onclick="openModal()">ï¼‹ è¿½åŠ </button>
        <button class="btn btn-edit" id="toggle-btn" onclick="toggleEdit()">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    </div>

    <ul id="task-list"></ul>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="m-title">ã‚¿ã‚¹ã‚¯</h3>
            <input type="text" id="in-name" placeholder="ãªã«ã‚’ã™ã‚‹ï¼Ÿ">
            <input type="number" id="in-time" placeholder="ä½•åˆ†ã‹ã‹ã‚‹ï¼Ÿ">
            <button class="btn btn-add" onclick="saveTask()">ä¿å­˜</button>
            <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('tadaima_v2')) || [
            {id: 1, name: "å®¿é¡Œ", time: 30, done: false},
            {id: 2, name: "ãŠé¢¨å‘‚", time: 20, done: false}
        ];
        let editId = null;

        function render() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            let total = 0;

            tasks.forEach(t => {
                if (!t.done) total += parseInt(t.time);
                const li = document.createElement('li');
                li.className = `card ${t.done ? 'checked' : ''}`;
                li.innerHTML = `
                    <div class="handle"><i class="fas fa-bars"></i></div>
                    <div class="check-btn" onclick="check(${t.id})">${t.done ? 'âœ“' : ''}</div>
                    <div style="flex:1">
                        <div class="name">${t.name}</div>
                        <div style="font-size:0.7rem; color:#888">${t.time}åˆ†</div>
                    </div>
                    <div class="edit-tool">
                        <i class="fas fa-edit" onclick="openModal(${t.id})"></i>
                        <i class="fas fa-trash" onclick="del(${t.id})"></i>
                    </div>
                `;
                list.appendChild(li);
            });

            const now = new Date();
            const bed = new Date(now.getTime() + total * 60000);
            document.getElementById('now-t').innerText = now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0');
            document.getElementById('bed-t').innerText = bed.getHours() + ":" + String(bed.getMinutes()).padStart(2,'0');
            document.getElementById('left-t').innerText = `ã®ã“ã‚Šåˆè¨ˆ: ${total}åˆ†`;
            localStorage.setItem('tadaima_v2', JSON.stringify(tasks));
        }

        function check(id) {
            const t = tasks.find(x => x.id === id);
            t.done = !t.done;
            render();
        }

        function toggleEdit() {
            document.body.classList.toggle('edit-mode');
            document.getElementById('toggle-btn').innerText = 
                document.body.classList.contains('edit-mode') ? "å®Œäº†" : "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
        }

        function openModal(id = null) {
            editId = id;
            if (id) {
                const t = tasks.find(x => x.id === id);
                document.getElementById('in-name').value = t.name;
                document.getElementById('in-time').value = t.time;
            } else {
                document.getElementById('in-name').value = '';
                document.getElementById('in-time').value = '';
            }
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function saveTask() {
            const n = document.getElementById('in-name').value;
            const t = document.getElementById('in-time').value;
            if (!n || !t) return;
            if (editId) {
                const task = tasks.find(x => x.id === editId);
                task.name = n; task.time = t;
            } else {
                tasks.push({id: Date.now(), name: n, time: t, done: false});
            }
            closeModal(); render();
        }

        function del(id) {
            tasks = tasks.filter(x => x.id !== id);
            render();
        }

        new Sortable(document.getElementById('task-list'), {
            handle: '.handle', animation: 150, onEnd: () => {
                const newTasks = [];
                document.querySelectorAll('.name').forEach(el => {
                    const found = tasks.find(x => x.name === el.innerText);
                    if(found) newTasks.push(found);
                });
                tasks = newTasks;
                render();
            }
        });

        setInterval(render, 30000); // 30ç§’ã”ã¨ã«æ™‚è¨ˆæ›´æ–°
        render();
    </script>
</body>
</html>
