<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŸã ã„ã¾ã£ã´ãƒ¼ V4.9</title>
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zasuyuka/tadaimappy/main/tadaimappy-icon.png">
    <link rel="icon" href="https://raw.githubusercontent.com/zasuyuka/tadaimappy/main/tadaimappy-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root { --main-blue: #3b82f6; --bg-color: #f3f8ff; --card-white: #ffffff; --text-main: #2c3e50; --success: #4cd964; --danger: #ff3b30; --warning: #f1c40f; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        .dashboard { background: var(--card-white); width: 100%; max-width: 600px; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; box-sizing: border-box; }
        .time-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .time-value { font-size: 1.8rem; font-weight: 800; color: var(--main-blue); }
        .bedtime-edit { cursor: pointer; border-bottom: 2px dashed var(--main-blue); } /* å¯ã‚‹æ™‚é–“ã‚’ã‚¿ãƒƒãƒ—å¯èƒ½ã« */
        
        .analog-clock { width: 100px; height: 100px; background: white; border: 4px solid #333; border-radius: 50%; position: relative; }
        .hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom; background: #333; border-radius: 4px; }
        .hour-hand { width: 5px; height: 25%; } .min-hand { width: 3px; height: 40%; } .sec-hand { width: 1.5px; height: 45%; background: var(--danger); }
        
        .progress-wrapper { height: 28px; background: #eee; border-radius: 14px; overflow: hidden; position: relative; }
        #progress-bar { height: 100%; width: 0%; transition: width 0.5s; background: var(--main-blue); }

        .list-container { width: 100%; max-width: 600px; }
        .task-card { background: white; margin-bottom: 12px; padding: 15px; border-radius: 18px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02); min-height: 80px; box-sizing: border-box; cursor: grab; }
        .task-card:active { cursor: grabbing; }
        .task-card.checked { opacity: 0.6; background: #f8fafc; }
        
        .task-icon { width: 50px; height: 50px; background: #f0f7ff; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; color: var(--main-blue); margin-right: 15px; }
        .check-circle { width: 45px; height: 45px; border: 2px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; flex-shrink: 0; }
        .checked .check-circle { background: var(--success); border-color: var(--success); color: white; }

        #timer-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .timer-display { font-size: 6rem; font-weight: 800; margin: 20px 0; font-variant-numeric: tabular-nums; }

        .btn { border: none; padding: 12px 20px; border-radius: 15px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn-blue { background: var(--main-blue); color: white; }
        
        .edit-controls { display: none; margin-left: auto; gap: 15px; font-size: 1.3rem; }
        body.edit-mode .edit-controls { display: flex; }
        body.edit-mode .check-circle, body.edit-mode .timer-btn { display: none; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; }
        .modal-content input, .modal-content select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>ãŸã ã„ã¾ã£ã´ãƒ¼ <small>V4.9</small></h1>

    <div class="dashboard">
        <div class="time-row">
            <div style="text-align:center">ä»Š<br><span class="time-value" id="now-val">--:--</span></div>
            <div class="analog-clock">
                <div class="hand hour-hand" id="hour-hand"></div>
                <div class="hand min-hand" id="min-hand"></div>
                <div class="hand sec-hand" id="sec-hand"></div>
            </div>
            <div style="text-align:center" onclick="editBedtime()">å¯ã‚‹<br><span class="time-value bedtime-edit" id="bed-val">21:00</span></div>
        </div>
        <div class="progress-wrapper"><div id="progress-bar"></div></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold; font-size:1.1rem;">
            <span id="stat-total">åˆè¨ˆ: --</span><span id="stat-free">è‡ªç”±: --</span>
        </div>
    </div>

    <div class="list-container">
        <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:flex-end;">
            <button class="btn" style="background:var(--warning); color:white" id="edit-toggle-btn" onclick="toggleEditMode()">âœï¸ ç·¨é›†</button>
            <button class="btn btn-blue" onclick="openTaskModal()">ï¼‹ è¿½åŠ </button>
        </div>
        <ul id="task-list" style="padding:0; list-style:none"></ul>
    </div>

    <div id="timer-overlay">
        <h2 id="timer-task-name"></h2>
        <div class="timer-display" id="timer-main">00:00</div>
        <div id="timer-diff-text" style="font-size:1.5rem; margin-bottom:30px"></div>
        <button class="btn btn-blue" style="width:220px; height:80px; font-size:1.6rem;" onclick="stopTimer(true)">ãŠã‚ã£ãŸï¼</button>
        <button class="btn" style="margin-top:30px; background:#f1f5f9; color:#64748b;" onclick="stopTimer(false)">ã¨ã‚ã‚‹</button>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">äºˆå®šã‚’ã„ã‚Œã‚‹</h3>
            <input type="text" id="in-name" placeholder="ãªã¾ãˆ">
            <input type="number" id="in-time" placeholder="ç›®æ¨™ã®æ™‚é–“ï¼ˆåˆ†ï¼‰">
            <select id="in-icon">
                <option value="book">ğŸ“š å‹‰å¼·</option><option value="bath">â™¨ï¸ ãŠé¢¨å‘‚</option>
                <option value="tooth">ğŸª¥ æ­¯ã¿ãŒã</option><option value="bed">ğŸ’¤ å¯ã‚‹</option>
                <option value="shirt">ğŸ‘• ç€æ›¿ãˆ</option><option value="gamepad">ğŸ® éŠã³</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-blue" style="flex:1" onclick="saveTask()">ä¿å­˜</button>
                <button class="btn" style="flex:1; background:#eee" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyJL8IZONFaSpzh3DUo3nmPNGIwe5uTXP8t5f-lzLOEaS_D6wZaYfga46qaL9hz_Q31/exec"; 

        const defaultTasks = [
            {id: 1, name: "å®¿é¡Œ", time: 45, icon: "book", done: false, elapsed: 0},
            {id: 2, name: "ãŠé¢¨å‘‚ã‚’æ²¸ã‹ã™", time: 10, icon: "bath", done: false, elapsed: 0},
            {id: 3, name: "ãŠé¢¨å‘‚ã«å…¥ã‚‹", time: 30, icon: "bath", done: false, elapsed: 0},
            {id: 4, name: "æ­¯ç£¨ã", time: 3, icon: "tooth", done: false, elapsed: 0},
            {id: 5, name: "å¸ƒå›£ã‚’ç•³ã‚€", time: 7, icon: "bed", done: false, elapsed: 0},
            {id: 6, name: "æ´—æ¿¯ç‰©ã‚’ã—ã¾ã†", time: 10, icon: "shirt", done: false, elapsed: 0},
            {id: 7, name: "ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸", time: 20, icon: "gamepad", done: false, elapsed: 0},
            {id: 8, name: "ã‚²ãƒ¼ãƒ ", time: 120, icon: "gamepad", done: false, elapsed: 0}
        ];

        let tasks = JSON.parse(localStorage.getItem('tadaima_v49_tasks')) || defaultTasks;
        let bedtime = localStorage.getItem('tadaima_v49_bedtime') || "21:00";
        let timerState = JSON.parse(localStorage.getItem('tadaima_v49_timer_state')) || null;
        let editId = null;

        function formatHM(minutes) {
            const m = Math.abs(minutes);
            const h = Math.floor(m / 60); const min = m % 60;
            let res = h > 0 ? h + "æ™‚é–“" : "";
            return (minutes < 0 ? "-" : "") + res + min + "åˆ†";
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('now-val').innerText = now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0');
            const h = (now.getHours() % 12) * 30 + now.getMinutes() * 0.5;
            const m = now.getMinutes() * 6; const s = now.getSeconds() * 6;
            document.getElementById('hour-hand').style.transform = `translateX(-50%) rotate(${h}deg)`;
            document.getElementById('min-hand').style.transform = `translateX(-50%) rotate(${m}deg)`;
            document.getElementById('sec-hand').style.transform = `translateX(-50%) rotate(${s}deg)`;
            if(timerState) updateTimerLogic();
        }

        function render() {
            const list = document.getElementById('task-list'); list.innerHTML = '';
            let totalRemaining = 0;
            tasks.forEach(t => {
                if(!t.done) totalRemaining += parseInt(t.time);
                const li = document.createElement('li');
                li.className = `task-card ${t.done ? 'checked' : ''}`;
                li.dataset.id = t.id; // ä¸¦ã³æ›¿ãˆç”¨
                li.innerHTML = `
                    <button class="btn timer-btn" onclick="startTimer(${t.id})" style="margin-right:15px; background:#e0f2fe; color:#3b82f6; width:45px; height:45px; border-radius:50%;"><i class="fas fa-play"></i></button>
                    <div class="task-icon"><i class="fas fa-${t.icon}"></i></div>
                    <div style="flex:1"><b>${t.name}</b><br><small>ç›®æ¨™:${formatHM(t.time)} ${t.elapsed > 0 ? ' (ç¾åœ¨:'+formatHM(Math.floor(t.elapsed/60))+')' : ''}</small></div>
                    <div class="check-circle" onclick="toggleCheck(${t.id})">${t.done ? 'âœ“' : ''}</div>
                    <div class="edit-controls">
                        <i class="fas fa-edit" onclick="openTaskModal(${t.id})" style="color:var(--main-blue)"></i>
                        <i class="fas fa-trash" onclick="deleteTask(${t.id})" style="color:var(--danger)"></i>
                    </div>
                `;
                list.appendChild(li);
            });
            calculateStatus(totalRemaining);
            localStorage.setItem('tadaima_v49_tasks', JSON.stringify(tasks));
        }

        // è¨ˆæ¸¬ã®ç¶™ç¶šæ©Ÿèƒ½ã‚’æ­è¼‰ã—ãŸã‚¹ã‚¿ãƒ¼ãƒˆ
        function startTimer(id) {
            const task = tasks.find(x => x.id === id);
            // å®Œäº†æ¸ˆã¿ãªã‚‰æœªå®Œäº†ã«æˆ»ã—ã¦å†é–‹
            if(task.done) {
                task.done = false;
            }
            timerState = { taskId: id, startTime: Date.now(), baseElapsed: task.elapsed };
            localStorage.setItem('tadaima_v49_timer_state', JSON.stringify(timerState));
            document.getElementById('timer-overlay').style.display = 'flex';
            document.getElementById('timer-task-name').innerText = task.name;
            render();
        }

        function updateTimerLogic() {
            const task = tasks.find(x => x.id === timerState.taskId);
            const totalElapsed = timerState.baseElapsed + Math.floor((Date.now() - timerState.startTime) / 1000);
            const m = Math.floor(totalElapsed / 60); const s = totalElapsed % 60;
            document.getElementById('timer-main').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            const remain = (task.time * 60) - totalElapsed;
            const diffText = document.getElementById('timer-diff-text');
            if(remain >= 0) {
                diffText.innerText = `ã®ã“ã‚Š ç´„ ${formatHM(Math.ceil(remain/60))}`; diffText.style.color = "var(--main-blue)";
            } else {
                diffText.innerText = `${formatHM(Math.floor(Math.abs(remain)/60))} ã‚ªãƒ¼ãƒãƒ¼ï¼`; diffText.style.color = "var(--danger)";
            }
        }

        function stopTimer(isComplete) {
            if(!timerState) return;
            const task = tasks.find(x => x.id === timerState.taskId);
            task.elapsed = timerState.baseElapsed + Math.floor((Date.now() - timerState.startTime) / 1000);
            if(isComplete) {
                task.done = true;
                sendLogToGAS(task.name, task.time, task.elapsed);
            }
            timerState = null;
            localStorage.removeItem('tadaima_v49_timer_state');
            document.getElementById('timer-overlay').style.display = 'none';
            render();
        }

        async function sendLogToGAS(taskName, goalTime, elapsedTime) {
            if (!GAS_URL || GAS_URL.includes("ã“ã“ã«")) return;
            try { fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ taskName, goalTime, elapsedTime }) }); } catch (e) {}
        }

        function calculateStatus(totalRemaining) {
            const now = new Date(); const [bH, bM] = bedtime.split(':').map(Number);
            const bedDate = new Date(); bedDate.setHours(bH, bM, 0);
            if (bedDate < now) bedDate.setDate(bedDate.getDate() + 1);
            const diffMin = Math.floor((bedDate - now) / 60000);
            const freeMin = diffMin - totalRemaining;
            const bar = document.getElementById('progress-bar');
            bar.style.width = Math.min(100, (totalRemaining / diffMin) * 100) + "%";
            bar.style.backgroundColor = freeMin < 0 ? "var(--danger)" : "var(--main-blue)";
            document.getElementById('stat-total').innerText = `åˆè¨ˆ: ${formatHM(totalRemaining)}`;
            document.getElementById('stat-free').innerText = `è‡ªç”±: ${formatHM(freeMin)}`;
            document.getElementById('bed-val').innerText = bedtime;
        }

        // å¯ã‚‹æ™‚é–“ã‚’ç·¨é›†
        function editBedtime() {
            const newTime = prompt("ä½•æ™‚ã«å¯ã‚‹ï¼Ÿ (ä¾‹ 21:00)", bedtime);
            if(newTime && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(newTime)) {
                bedtime = newTime;
                localStorage.setItem('tadaima_v49_bedtime', bedtime);
                render();
            } else if(newTime) {
                alert("21:00 ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¦ã­");
            }
        }

        function toggleEditMode() {
            const isEdit = document.body.classList.toggle('edit-mode');
            document.getElementById('edit-toggle-btn').innerText = isEdit ? "âœ… å®Œäº†" : "âœï¸ ç·¨é›†";
            sortable.option("disabled", !isEdit); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘ä¸¦ã³æ›¿ãˆå¯èƒ½
        }

        // ä¸¦ã³æ›¿ãˆã®åˆæœŸåŒ–
        const sortable = new Sortable(document.getElementById('task-list'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            disabled: true,
            onEnd: function() {
                const newOrder = sortable.toArray();
                tasks = newOrder.map(id => tasks.find(t => t.id == id));
                render();
            }
        });

        function openTaskModal(id = null) {
            editId = id;
            if(id) {
                const t = tasks.find(x => x.id === id);
                document.getElementById('modal-title').innerText = "äºˆå®šã‚’ãªãŠã™";
                document.getElementById('in-name').value = t.name;
                document.getElementById('in-time').value = t.time;
                document.getElementById('in-icon').value = t.icon;
            } else {
                document.getElementById('modal-title').innerText = "äºˆå®šã‚’ã„ã‚Œã‚‹";
                document.getElementById('in-name').value = ''; document.getElementById('in-time').value = '';
            }
            document.getElementById('taskModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('taskModal').style.display = 'none'; }
        function saveTask() {
            const n = document.getElementById('in-name').value;
            const t = document.getElementById('in-time').value;
            const i = document.getElementById('in-icon').value;
            if(!n || !t) return;
            if(editId) {
                const tk = tasks.find(x => x.id === editId);
                tk.name = n; tk.time = parseInt(t); tk.icon = i;
            } else {
                tasks.push({id: Date.now(), name: n, time: parseInt(t), icon: i, done: false, elapsed: 0});
            }
            closeModal(); render();
        }
        function deleteTask(id) { if(confirm('æ¶ˆã—ã¦ã‚‚ã„ã„ï¼Ÿ')) { tasks = tasks.filter(x => x.id !== id); render(); } }
        function toggleCheck(id) { const t = tasks.find(x => x.id === id); t.done = !t.done; if(!t.done) t.elapsed = 0; render(); }

        setInterval(updateClock, 1000);
        if(timerState) document.getElementById('timer-overlay').style.display = 'flex';
        render();
    </script>
</body>
</html>
